---
title: "Data Wrangling"
author: "Erin Anthony"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Read in the data
```{r read in the data}
stem = read.csv("csv-data/all-data.csv") # 7357 obs of 150 variables
```

### Examine the variable levels of the data selection variables
```{r examine the variable levels of the data selection variables}
levels(stem$HD2015.Undergraduate.offering) # remove "No undergraduate offering"
levels(stem$HD2015.Degree.granting.status) # remove "Nondegree-granting, primarily postsecondary"
levels(stem$HD2015.Institution.is.active.in.current.year) # remove missing values
levels(stem$IC2015.Bachelor.s.degree) # remove missing values, remove "Implied no", remove "Not applicable"
```

### Examine the variable levels of the independent variables
```{r examine the variable levels of the independent variables}
levels(stem$HD2015.Bureau.of.Economic.Analysis..BEA..regions) # categorical, missing values
levels(stem$HD2015.Historically.Black.College.or.University) # binary, missing values
levels(stem$HD2015.Tribal.college) # binary, missing values
levels(stem$HD2015.Degree.of.urbanization..Urban.centric.locale.) # categorical, missing values
levels(stem$IC2015.Open.admission.policy) # binary, missing values, remove "Not applicable"
levels(stem$HD2015.Land.Grant.Institution) # binary, remove missing values
levels(stem$IC2015.Associate.s.degree) # binary, missing values
levels(stem$IC2015.All.programs.offered.completely.via.distance.education) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Undergraduate.programs.or.courses.are.offered.via.distance.education) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Study.abroad) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Weekend.evening..college) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Remedial.services) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Academic.career.counseling.service) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Employment.services.for.students) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Placement.services.for.completers) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.On.campus.day.care.for.students..children) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Tuition.guaranteed.plan) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Prepaid.tuition.plan) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Tuition.payment.plan) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Institution.provide.on.campus.housing) # binary, missing values, "Not applicable", "Not reported"
levels(stem$IC2015.Institution.provides.board.or.meal.plan) # binary, two "Yes" levels, missing values, "Not applicable", "Not reported"
levels(stem$IC2015_AY.In.state.average.tuition.for.full.time.undergraduates) # ratio, missing values
levels(stem$IC2015_AY.Out.of.state.average.tuition.for.full.time.undergraduates) # ratio, missing values
levels(stem$HD2015.Institution.size.category) # categorical, missing values, "Not applicable", "Not reported"
levels(stem$EF2015D.Student.to.faculty.ratio) # ratio, missing values
levels(stem$SFA1415.Average.amount.of.federal..state..local..institutional.or.other.sources.of.grant.aid.awarded.to.undergraduate.students) # ratio, missing values
levels(stem$SFA1415.Average.amount.of.federal.student.loans.awarded.to.undergraduate.students) # ratio, missing values
```

### Examine the variable levels of the dependent variables
```{r examine the variable levels of the dependent variables}
levels(stem$DRVEF2015.Percent.of.undergraduate.enrollment.that.are.Black.or.African.American) # ratio, missing values
levels(stem$DRVEF2015.Percent.of.undergraduate.enrollment.that.are.Hispanic.Latino) # ratio, missing values
levels(stem$DRVGR2015.Graduation.rate...Bachelor.degree.within.6.years..Black..non.Hispanic) # ratio, missing values
levels(stem$DRVGR2015.Graduation.rate...Bachelor.degree.within.6.years..Hispanic) # ratio, missing values
```

### Trim the data set and rename the columns
```{r trim the data set and rename the columns}
stem.df <- stem[, c(10,12,18,26,8,13,14,15,17,21,24,34,35,38,39,40,
                      41,42,43,44,46,47,48,49,50,51,53,71,113,117,121,
                      93,94,144,145)] # 7357 obs of 35 variables

colnames(stem.df) <- c("ugrad", "degree", "active", "bachelors", "region", "hbcu", "tribal", "urban", "open", "landGrant", "associates", "allDistance", "partDistance", "studyAbroad", "weekend", "remedial", "counseling", "employment", "placement", "dayCare", "tuitionGuarantee", "tuitionPrepaid", "tuitionPlan", "oncampusHousing", "mealPlan", "instateTuition", "outstateTuition", "size", "facultyRatio", "grantAid", "loanAid", "blackEnroll", "latinoEnroll", "blackGrad", "latinoGrad")
```

### Only include active institutions granting Bachelor's degrees
```{r only include active institutions granting Bachelor's degrees}
stem.df <- subset(stem.df, ugrad=="Undergraduate degree or certificate offering" & degree=="Degree-granting" & active=="Yes" & bachelors=="Yes") # 2752 obs of 35 variables
```

### Examine data to determine missing value imputation methods
```{r examine data to determine missing value imputation methods}
# find rows where data is missing from most columns
NA.df <- stem.df[(is.na(stem.df$blackEnroll) & is.na(stem.df$latinoEnroll) & is.na(stem.df$blackGrad) & is.na(stem.df$latinoGrad) & is.na(stem.df$instateTuition) & stem.df$open=="Not applicable" | stem.df$allDistance=="Not reported"),]

head(NA.df, 5)

# remove these rows
stem.df <- stem.df[!row.names(stem.df) %in% row.names(NA.df),]
# 2709 obs of 35 variables

table(stem.df$region) # categorical, no missing values
table(stem.df$hbcu) # 2623 No, 86 Yes, no missing values
table(stem.df$tribal) # 2696 No, 13 Yes, no missing values
table(stem.df$urban) # categorical, no missing values

table(stem.df$open) # 1874 No, 701 Yes, 134 Not applicable*** 
# replace 'N/A' values in the 'open' column with 'No' values
stem.df$open[stem.df$open=="Not applicable"] <- "No"
table(stem.df$open) # 2008 No, 701 Yes, no missing values

table(stem.df$landGrant) # 2625 No, 84 Yes, no missing values
table(stem.df$associates) # 1193 No, 1516 Yes, no missing values
table(stem.df$allDistance) # 2668 No, 41 Yes, no missing values
table(stem.df$partDistance) # 2017 Yes, 692 No, no missing values
table(stem.df$studyAbroad) # 1584 Yes, 1125 No, no missing values
table(stem.df$weekend) # 1371 No, 1338 Yes, no missing values
table(stem.df$remedial) # 1879 Yes, 830 No, no missing values
table(stem.df$counseling) # 2662 Yes, 47 No, no missing values
table(stem.df$employment) # 2304 Yes, 405 No, no missing values
table(stem.df$placement) # 2146 Yes, 563 No, no missing values
table(stem.df$dayCare) # 2236 No, 473 Yes, no missing values
table(stem.df$tuitionGuarantee) # 2537 No, 172 Yes, no missing values
table(stem.df$tuitionPrepaid) # 2448 No, 261 Yes, no missing values
table(stem.df$tuitionPlan) # 2267 Yes, 442 No, no missing values
table(stem.df$oncampusHousing) # 1764 Yes, 945 No, no missing values

table(stem.df$mealPlan) # 1620 Yes (2 lev), 1089 No, no missing values
# combine the two 'Yes' levels into one
stem.df$mealPlan <- with(stem.df, ifelse(mealPlan=="Yes, number of meals in the maximum meal plan offered"|mealPlan=="Yes, number of meals per week can vary", "Yes", "No"))
table(stem.df$mealPlan)

table(stem.df$instateTuition) # numerical, 42 missing values***
# replace N/A values in the 'instateTuition' column with the median 
median(stem.df$instateTuition, na.rm=TRUE) # 15300
stem.df$instateTuition[is.na(stem.df$instateTuition)] <- 15300
colSums(is.na(stem.df))

table(stem.df$outstateTuition) # numerical, 42 few missing values***
# replace N/A values in the 'outstateTuition' column with the median 
median(stem.df$outstateTuition, na.rm=TRUE) # 17748
stem.df$outstateTuition[is.na(stem.df$outstateTuition)] <- 17748
colSums(is.na(stem.df))

table(stem.df$size) # 5 levels, 1 Not reported***
# replace 'Not reported' value in the 'size' column with the mode
mode <- function(n) {
   uniq <- unique(n)
   uniq[which.max(tabulate(match(n, uniq)))]
}
mode(stem.df$size) # "Under 1,000"
stem.df$size[stem.df$size=="Not reported"] <- "Under 1,000"
table(stem.df$size)

table(stem.df$facultyRatio) # numerical, 11 missing values***
# engineer a new independent variable to rank size by levels
stem.df$sizeLevel <- with(stem.df, ifelse(size=="Under 1,000", 1, ifelse(size=="1,000 - 4,999", 2, ifelse(size=="5,000 - 9,999", 3, ifelse(size=="10,000 - 19,999", 4, 5)))))
# calculate all numerical variable correlations for faculty ratio
cor(stem.df[, "facultyRatio"], stem.df[, sapply(stem.df, is.numeric)], use="complete.obs")
# there are no strong correlations, so use the median instead
median(stem.df$facultyRatio, na.rm=TRUE) # 13
stem.df$facultyRatio[is.na(stem.df$facultyRatio)] <- 13
colSums(is.na(stem.df))

table(stem.df$grantAid) # numerical, 25 missing values***
# calculate all numerical variable correlations for grant aid
cor(stem.df[, "grantAid"], stem.df[, sapply(stem.df, is.numeric)], use="complete.obs")
# there is a correlation of 86% between grant aid and in-state tuition
# examine the spread of in-state tuition
qts <- quantile(stem.df$instateTuition) # 0, 8850, 15300, 25587, 55944
# calculate median tuition for each tuition quartile
tapply(stem.df$instateTuition, findInterval(stem.df$instateTuition, qts), median) # 5681, 11800, 17748, 33678
# examine the spread of grant aid
qns <- quantile(stem.df$grantAid, na.rm=TRUE) # 609, 4780.75, 7163, 14467.5, 44724
# calculate the median aid for each grant aid quartile
tapply(stem.df$grantAid, findInterval(stem.df$grantAid, qns), median) # 3941, 5825, 9612, 19917.5
# impute the missing grant aid values
grantNA.df <- stem.df[is.na(stem.df$grantAid),]
for(i in 1:nrow(grantNA.df)){
  if(grantNA.df$instateTuition[i] <= 8850) {
    grantNA.df$grantAid[i] <- (3941/5681*grantNA.df$instateTuition[i]) } 
  else if(grantNA.df$instateTuition[i] <= 15300) {
    grantNA.df$grantAid[i] <- (5825/11800*grantNA.df$instateTuition[i]) }
  else if(grantNA.df$instateTuition[i] <= 25587) {
    grantNA.df$grantAid[i] <- (9612/17748*grantNA.df$instateTuition[i]) }
  else { grantNA.df$grantAid[i] <-   (19917.5/33678*grantNA.df$instateTuition[i]) }
}
table(grantNA.df$grantAid) 
if(row.names(stem.df) %in% row.names(grantNA.df)) {
  # update values in stem.df$grantAid column using grantNA.df$grantAid
}
colSums(is.na(stem.df))

table(stem.df$loanAid) # numerical, no missing values
```


### Feature engineer some new independent variables
```{r feature engineer some new independent variables}
# combine employment and placement services
stem.df$placeEmploy <- with(stem.df, ifelse(employment=="Yes"|placement=="Yes", "Yes", "No"))

# combine tuition guarantee, prepaid tuition, and tuition payment plan
stem.df$tuitionOptions <- with(stem.df, ifelse(tuitionGuarantee=="Yes"|tuitionPlan=="Yes"|tuitionPrepaid=="Yes", "Yes", "No"))

# calculate the ratio of out-of-state to in-state tuition
stem.df$tuitionRatio <- stem.df$outstateTuition/stem.df$instateTuition
```